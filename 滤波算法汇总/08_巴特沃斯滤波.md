# 巴特沃斯滤波算法详解

## 一、算法原理

### 1.1 什么是巴特沃斯滤波器？

巴特沃斯滤波器（Butterworth Filter）是一种信号处理中的滤波器，由英国工程师斯蒂芬·巴特沃斯（Stephen Butterworth）在1930年首次提出。它的最大特点是在通带内具有**最平坦的频率响应**，没有波纹。

**形象比喻**：
想象你在调节音响的音量，巴特沃斯滤波器就像是一个非常"温柔"的音量调节器。它不会突然把某个频率的声音调高或调低，而是平滑、均匀地调节，让整体听起来非常舒服。

### 1.2 数学原理

#### 频域特性

巴特沃斯滤波器的幅频响应函数为：

```
|H(jω)|² = 1 / (1 + (ω/ωc)^(2n))
```

其中：
- `ω` 是角频率（单位：rad/s）
- `ωc` 是截止频率（单位：rad/s）
- `n` 是滤波器的阶数（1阶、2阶、3阶...）

**关键特性**：
1. 当 `ω = 0` 时，`|H(jω)| = 1`（低频信号完全通过）
2. 当 `ω = ωc` 时，`|H(jω)| = 1/√2 ≈ 0.707`（-3dB点）
3. 当 `ω → ∞` 时，`|H(jω)| → 0`（高频信号被抑制）

#### 阶数的影响

- **1阶滤波器**：衰减斜率为 -20dB/decade（每10倍频程衰减20dB）
- **2阶滤波器**：衰减斜率为 -40dB/decade
- **n阶滤波器**：衰减斜率为 -20n dB/decade

阶数越高，滤波效果越好，但计算复杂度也越高。

### 1.3 二阶巴特沃斯低通滤波器

在嵌入式系统中，二阶巴特沃斯滤波器是最常用的，它在性能和计算量之间取得了很好的平衡。

#### 传递函数（拉普拉斯域）

```
H(s) = ωc² / (s² + √2·ωc·s + ωc²)
```

#### 差分方程（时域实现）

通过双线性变换（Bilinear Transform）将连续时间滤波器转换为离散时间滤波器：

```
y[n] = a0·x[n] + a1·x[n-1] + a2·x[n-2] - b1·y[n-1] - b2·y[n-2]
```

其中，系数计算公式为：

```
ωc = 2π·fc                    // 截止频率（角频率）
T = 1/fs                       // 采样周期
ωd = ωc·T                      // 归一化角频率

Q = 1/√2 ≈ 0.7071             // 品质因数（二阶巴特沃斯固定值）
K = tan(ωd/2)                  // 预畸变因子

norm = 1/(1 + K/Q + K²)        // 归一化系数

a0 = K²·norm                   // 前向系数
a1 = 2·a0
a2 = a0

b1 = 2·(K² - 1)·norm          // 反馈系数
b2 = (1 - K/Q + K²)·norm
```

### 1.4 工作机制

巴特沃斯滤波器通过以下方式工作：

1. **存储历史数据**：保存前2个输入值（x[n-1], x[n-2]）和前2个输出值（y[n-1], y[n-2]）
2. **加权求和**：将当前输入和历史数据按系数加权求和
3. **反馈机制**：输出值不仅依赖输入，还依赖历史输出（IIR结构）
4. **频率选择**：低于截止频率的信号通过，高于截止频率的信号被衰减

## 二、C语言实现

详细代码请参考 `08_巴特沃斯滤波.c` 文件。

### 核心数据结构

```c
typedef struct {
    float a0, a1, a2;      // 前向系数
    float b1, b2;          // 反馈系数
    float x1, x2;          // 历史输入
    float y1, y2;          // 历史输出
} ButterworthFilter;
```

### 核心函数

```c
// 初始化滤波器（计算系数）
void Butterworth_Init(ButterworthFilter* filter, float fc, float fs);

// 滤波处理
float Butterworth_Update(ButterworthFilter* filter, float input);
```

## 三、优缺点分析

### 3.1 优点

| 优点 | 说明 |
|------|------|
| **通带平坦** | 在通带内频率响应最平坦，无波纹，信号失真小 |
| **特性可预测** | 数学特性明确，参数设计简单 |
| **相位线性度好** | 相位响应相对平滑（虽不如贝塞尔滤波器） |
| **广泛应用** | 工程中最常用的滤波器类型之一 |
| **计算效率高** | 二阶滤波器只需5个乘法和4个加法 |
| **易于级联** | 可通过级联多个二阶滤波器实现高阶滤波 |

### 3.2 缺点

| 缺点 | 说明 |
|------|------|
| **过渡带较宽** | 从通带到阻带的过渡不够陡峭（不如切比雪夫） |
| **截止不够锐利** | 需要更高阶数才能达到陡峭的衰减 |
| **有相位失真** | 非线性相位特性，会导致信号延迟 |
| **需要浮点运算** | 系数通常是浮点数，需要浮点运算支持 |
| **稳定性要求高** | 参数设置不当可能导致数值不稳定 |

## 四、适用场景

### 4.1 嵌入式系统中的典型应用

#### 1. **传感器信号处理** ⭐⭐⭐⭐⭐

**应用场景**：
- 温度传感器（热电偶、NTC）
- 压力传感器
- 加速度计、陀螺仪
- 光电传感器

**为什么适合**：
- 传感器信号通常包含高频噪声
- 需要平坦的通带响应以保持信号准确性
- 对相位要求不是特别严格

**示例**：
```
温度传感器：fc = 1Hz（温度变化慢），fs = 100Hz
加速度计：fc = 10Hz（运动频率），fs = 1000Hz
```

#### 2. **电源滤波** ⭐⭐⭐⭐

**应用场景**：
- ADC参考电压滤波
- 电池电压监测
- 电源纹波抑制

**为什么适合**：
- 需要去除电源中的高频噪声和纹波
- 保持直流分量准确

#### 3. **音频信号处理** ⭐⭐⭐⭐

**应用场景**：
- 低音增强（低通）
- 高音去除（低通）
- 音频均衡器

**为什么适合**：
- 通带平坦，音质失真小
- 可设计高通、低通、带通等多种类型

#### 4. **通信系统** ⭐⭐⭐

**应用场景**：
- 基带信号滤波
- 抗混叠滤波（ADC前端）
- 重构滤波（DAC后端）

**为什么适合**：
- 需要平坦的通带和足够的阻带衰减

#### 5. **控制系统** ⭐⭐⭐

**应用场景**：
- PID控制器输入滤波
- 电机速度反馈滤波
- 位置传感器信号处理

**为什么适合**：
- 去除测量噪声，提高控制稳定性

### 4.2 不适合的场景

❌ **需要极陡峭截止特性的场合**（应选择切比雪夫或椭圆滤波器）
❌ **要求零相位失真的场合**（应选择贝塞尔滤波器或零相位滤波器）
❌ **极低功耗设备**（可考虑更简单的滑动平均或一阶滤波器）
❌ **整数运算MCU**（需要大量浮点运算，可改用定点实现）

## 五、参数调节建议

### 5.1 截止频率（fc）的选择

截止频率是最关键的参数，决定了滤波器的"分界线"。

#### 基本原则

```
fc应设置在有用信号频率和噪声频率之间
```

#### 实用经验公式

| 应用场景 | fc选择建议 |
|----------|-----------|
| **慢速信号**（温度、气压） | fc = (1~5) × 信号最高频率 |
| **中速信号**（加速度、角速度） | fc = (2~10) × 信号最高频率 |
| **快速信号**（音频、振动） | fc = (1~2) × 信号最高频率 |

#### 具体示例

1. **温度传感器**
   ```
   温度变化频率：< 0.1Hz
   建议fc：0.5~1Hz
   采样频率fs：10~100Hz（至少是fc的10倍）
   ```

2. **加速度计（步态检测）**
   ```
   步频范围：0.5~3Hz
   建议fc：5~10Hz
   采样频率fs：100~500Hz
   ```

3. **音频信号**
   ```
   人耳范围：20Hz~20kHz
   低通fc：15kHz（去除超声噪声）
   采样频率fs：44.1kHz或48kHz
   ```

### 5.2 采样频率（fs）的选择

#### 奈奎斯特定理

```
fs ≥ 2 × 信号最高频率
```

#### 实用建议

```
fs = (10~20) × fc
```

过高的采样率会增加计算负担，过低则会导致混叠。

### 5.3 阶数（n）的选择

#### 阶数对比

| 阶数 | 衰减斜率 | 计算量 | 适用场景 |
|------|---------|--------|---------|
| 1阶 | -20dB/decade | 很小 | 简单噪声抑制 |
| 2阶 | -40dB/decade | 小 | **最常用，性价比最高** |
| 3阶 | -60dB/decade | 中等 | 需要更好的滤波效果 |
| 4阶+ | -80dB/decade+ | 大 | 高要求场合 |

#### 建议

- **嵌入式系统首选2阶**：计算量适中，效果已经很好
- 如需更高阶，可级联多个2阶滤波器（更稳定）

### 5.4 实际调试流程

#### 步骤1：初步估算

```c
// 示例：陀螺仪滤波
float fc = 10.0f;      // 运动频率一般<10Hz
float fs = 1000.0f;    // 陀螺仪常见采样率
```

#### 步骤2：观察波形

- 如果输出仍有明显噪声 → **降低fc**
- 如果输出响应太慢、信号失真 → **提高fc**

#### 步骤3：量化评估

```c
// 计算信噪比改善
SNR_improvement = 10 * log10(variance_before / variance_after);
```

#### 步骤4：优化调整

```
fc_new = fc_old × adjustment_factor
```

- 噪声仍大：adjustment_factor = 0.5~0.8
- 响应太慢：adjustment_factor = 1.2~2.0

### 5.5 常见参数配置参考

```c
// 1. 温度传感器（NTC）
fc = 0.5Hz, fs = 10Hz, 阶数 = 2

// 2. 加速度计（姿态估计）
fc = 5Hz, fs = 200Hz, 阶数 = 2

// 3. 陀螺仪（姿态估计）
fc = 10Hz, fs = 1000Hz, 阶数 = 2

// 4. 电池电压检测
fc = 1Hz, fs = 100Hz, 阶数 = 2

// 5. 音频低通滤波
fc = 3400Hz, fs = 16000Hz, 阶数 = 4（级联2个2阶）

// 6. 心率传感器
fc = 5Hz, fs = 100Hz, 阶数 = 2
```

### 5.6 避免的常见错误

❌ **错误1：fc设置过高**
```
fc接近fs/2 → 滤波效果很差
正确：fc < fs/5
```

❌ **错误2：采样率太低**
```
fs < 2×信号频率 → 混叠失真
正确：fs ≥ 10×fc
```

❌ **错误3：盲目提高阶数**
```
阶数过高 → 数值不稳定、计算量大
正确：嵌入式系统优先用2阶，需要时级联
```

❌ **错误4：忽略初始化**
```
未清零历史数据 → 启动瞬态响应异常
正确：初始化时清零 x1, x2, y1, y2
```

## 六、总结

### 核心要点

1. **巴特沃斯滤波器 = 通带最平坦的IIR滤波器**
2. **二阶滤波器是嵌入式系统的最佳选择**
3. **关键参数：截止频率fc（决定滤波效果）**
4. **设计原则：fc介于信号频率和噪声频率之间**

### 适用性判断

✅ 适合：传感器信号处理、电源滤波、音频处理
❌ 不适合：需要极陡截止、零相位失真、超低功耗场合

### 调试建议

```
从默认参数开始 → 观察波形 → 调整fc → 量化评估 → 优化
```

---

**参考资料**：
- "Digital Signal Processing" by Alan V. Oppenheim
- "Designing Audio Effect Plug-Ins in C++" by Will Pirkle
- ARM CMSIS-DSP Library Documentation
