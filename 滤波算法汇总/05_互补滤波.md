# 互补滤波算法详解

## 一、算法原理

### 1.1 什么是互补滤波？

互补滤波（Complementary Filter）是一种简单而有效的传感器融合算法，特别适用于姿态估计。它的核心思想是：**结合两个或多个传感器的优点，同时规避它们的缺点**。

想象一下：
- **加速度计**：能准确测量静态角度（长期稳定），但容易受到振动干扰（短期不稳定）
- **陀螺仪**：短期内测量精准（响应快），但会产生累积误差（长期漂移）

互补滤波就像一个聪明的"裁判"，对加速度计说："我相信你的长期判断"，对陀螺仪说："我相信你的短期判断"，然后把两者的优点结合起来。

### 1.2 数学原理

#### 基本公式

互补滤波的核心公式非常简洁：

```
angle = α × (angle + gyro × dt) + (1-α) × accel
```

其中：
- `angle`：当前估计的角度
- `gyro`：陀螺仪测量的角速度
- `dt`：时间间隔
- `accel`：加速度计计算的角度
- `α`：互补滤波系数（0 < α < 1）

#### 公式分解

让我们把公式拆开看：

**第一部分：高通滤波（信任陀螺仪的短期数据）**
```
α × (angle + gyro × dt)
```
- `gyro × dt`：陀螺仪角速度积分得到角度变化
- `angle + gyro × dt`：上一次角度 + 这次变化 = 新角度
- `α`：给陀螺仪数据的权重（通常是0.95~0.99）

**第二部分：低通滤波（信任加速度计的长期数据）**
```
(1-α) × accel
```
- `accel`：加速度计直接计算的角度
- `(1-α)`：给加速度计数据的权重（通常是0.01~0.05）

**合在一起：**
- 95%相信陀螺仪的短期变化（快速响应）
- 5%相信加速度计的绝对值（防止漂移）

### 1.3 频域解释

从频率的角度看：

```
H_gyro(s) = α·s/(s+ω_c)        # 高通滤波器
H_accel(s) = (1-α)·ω_c/(s+ω_c) # 低通滤波器
H_total(s) = H_gyro + H_accel = 1  # 互补关系
```

**为什么叫"互补"？**
- 两个滤波器的频率响应加起来等于1
- 高频信号走陀螺仪通道
- 低频信号走加速度计通道
- 完美互补，不重叠不遗漏

### 1.4 截止频率

互补滤波系数α与截止频率的关系：

```
α = τ / (τ + dt)
```

其中：
- `τ = 1 / (2πf_c)`：时间常数
- `f_c`：截止频率
- `dt`：采样周期

**举例：**
- 采样频率 = 100Hz（dt = 0.01s）
- 截止频率 = 0.5Hz
- τ = 1/(2π×0.5) ≈ 0.318
- α = 0.318/(0.318+0.01) ≈ 0.97

## 二、算法优缺点

### 2.1 优点

1. **计算简单**
   - 只需要一次乘法和加法
   - 不需要矩阵运算（比卡尔曼滤波简单得多）
   - 适合资源受限的嵌入式系统

2. **实时性好**
   - 计算量小，执行速度快
   - 无延迟，适合控制系统

3. **效果显著**
   - 能有效抑制陀螺仪漂移
   - 能过滤加速度计的高频噪声
   - 对于简单姿态估计已经足够精确

4. **容易理解和调试**
   - 只有一个参数α需要调节
   - 物理意义明确
   - 调参简单直观

5. **鲁棒性强**
   - 对参数不敏感（在一定范围内）
   - 不容易发散

### 2.2 缺点

1. **只适用于小角度**
   - 使用简化的线性化模型
   - 大角度旋转时精度下降
   - 不能处理万向节死锁问题

2. **无法处理复杂动态**
   - 加速度计在加速运动时测量不准
   - 不能区分重力加速度和运动加速度
   - 剧烈运动时性能下降

3. **精度有限**
   - 比卡尔曼滤波精度低
   - 无法提供误差估计
   - 不能自适应调整

4. **需要手动调参**
   - α值需要根据应用场景调节
   - 不同运动状态可能需要不同参数
   - 没有最优参数自动计算

## 三、适用场景

### 3.1 典型应用

1. **无人机姿态控制**
   - 四旋翼飞行器的俯仰角、横滚角估计
   - 要求：快速响应、计算简单
   - 特点：小角度变化、实时性要求高

2. **平衡车/平衡机器人**
   - 倾角测量和控制
   - 要求：极高实时性、低延迟
   - 特点：单轴控制、对精度要求相对较低

3. **航模遥控**
   - 固定翼飞机、直升机的姿态稳定
   - 要求：轻量级算法、快速响应
   - 特点：连续平滑运动

4. **手持稳定器/云台**
   - 相机防抖、三轴稳定
   - 要求：低延迟、平滑输出
   - 特点：中等精度需求

5. **简易惯性导航**
   - 教学用惯性测量单元
   - 游戏手柄、VR手柄
   - 要求：成本低、易于实现

### 3.2 何时选择互补滤波？

**建议使用的情况：**
- ✅ 计算资源有限（单片机主频<100MHz）
- ✅ 实时性要求极高（控制周期<10ms）
- ✅ 运动相对平稳（角度变化<30°/s）
- ✅ 对精度要求不是特别高（±2°可接受）
- ✅ 开发周期紧张，需要快速实现

**建议使用其他算法的情况：**
- ❌ 需要高精度姿态估计（考虑卡尔曼滤波/EKF）
- ❌ 存在大角度快速旋转（考虑四元数+卡尔曼）
- ❌ 需要融合更多传感器（GPS、磁力计等）
- ❌ 需要自适应调整参数

### 3.3 与其他算法对比

| 特性 | 互补滤波 | 卡尔曼滤波 | 粒子滤波 |
|------|---------|-----------|---------|
| 计算复杂度 | 极低 | 中等 | 高 |
| 精度 | 中等 | 高 | 很高 |
| 实时性 | 优秀 | 良好 | 一般 |
| 易用性 | 简单 | 复杂 | 很复杂 |
| 适用场景 | 简单姿态 | 复杂系统 | 非线性系统 |
| 参数调节 | 1个参数 | 多个参数 | 大量参数 |

## 四、参数调节建议

### 4.1 α值选择指南

**基本原则：**
- α越大：越相信陀螺仪，响应越快，但长期会漂移
- α越小：越相信加速度计，越稳定，但响应变慢且易受干扰

**推荐值：**

```
α = 0.98  # 快速运动、高频控制（如竞速无人机）
α = 0.96  # 一般飞行器控制（平衡性能）
α = 0.95  # 平衡车（中等响应速度）
α = 0.90  # 慢速运动、需要更稳定（如云台）
```

### 4.2 根据采样频率调节

**方法一：根据截止频率计算**

```c
// 期望的截止频率（Hz）
float f_cutoff = 0.5;  // 0.5Hz适合大多数应用

// 采样频率（Hz）
float f_sample = 100;   // 100Hz采样
float dt = 1.0 / f_sample;

// 计算α
float tau = 1.0 / (2 * 3.14159 * f_cutoff);
float alpha = tau / (tau + dt);
// 结果：alpha ≈ 0.969
```

**方法二：经验公式**

```c
// 快速估算：α = 1 - (采样周期 × 系数)
float dt = 0.01;      // 100Hz采样
float alpha = 1 - (dt * 3);  // 系数通常在2~5之间
// 结果：alpha = 0.97
```

### 4.3 实际调参步骤

**步骤1：设定初始值**
```c
float alpha = 0.96;  // 从中间值开始
```

**步骤2：测试陀螺仪漂移**
```
1. 让设备静止不动
2. 观察角度输出是否缓慢漂移
3. 如果漂移明显：减小α（如0.96 → 0.95）
4. 如果稳定：保持或增大α
```

**步骤3：测试响应速度**
```
1. 快速转动设备
2. 观察角度是否跟随迅速
3. 如果响应慢：增大α（如0.96 → 0.98）
4. 如果响应足够快：保持或减小α
```

**步骤4：测试抗干扰能力**
```
1. 轻敲设备产生振动
2. 观察角度是否剧烈抖动
3. 如果抖动明显：增大α（过滤高频噪声）
4. 如果平滑：保持
```

### 4.4 不同应用的推荐参数

**竞速无人机：**
```c
float alpha = 0.98;   // 快速响应优先
float dt = 0.002;     // 500Hz高速采样
```

**航拍无人机：**
```c
float alpha = 0.96;   // 平衡响应和稳定性
float dt = 0.005;     // 200Hz采样
```

**平衡车：**
```c
float alpha = 0.95;   // 稳定性优先
float dt = 0.01;      // 100Hz采样
```

**手持云台：**
```c
float alpha = 0.92;   // 平滑优先，避免抖动
float dt = 0.01;      // 100Hz采样
```

### 4.5 动态调整策略

对于高级应用，可以根据运动状态动态调整α：

```c
// 检测运动状态
float gyro_magnitude = sqrt(gx*gx + gy*gy + gz*gz);

if (gyro_magnitude > 100) {
    // 快速运动：增大α，更相信陀螺仪
    alpha = 0.98;
} else if (gyro_magnitude < 10) {
    // 静止或慢速：减小α，更相信加速度计
    alpha = 0.92;
} else {
    // 正常运动：使用默认值
    alpha = 0.96;
}
```

### 4.6 调参常见问题

**问题1：角度一直漂移**
- 原因：α太大，陀螺仪零偏没有被修正
- 解决：减小α（如0.98 → 0.95）

**问题2：角度反应太慢**
- 原因：α太小，陀螺仪权重不够
- 解决：增大α（如0.93 → 0.96）

**问题3：角度抖动严重**
- 原因：α太小，加速度计噪声影响大
- 解决：增大α或增加加速度计低通滤波

**问题4：加速时角度跳变**
- 原因：加速度计受到运动加速度干扰
- 解决：增大α，或检测加速度幅值，动态调整

## 五、总结

### 5.1 核心要点

1. **互补滤波是最简单实用的传感器融合算法**
2. **适合资源受限、实时性要求高的嵌入式系统**
3. **只需调节一个参数α（通常0.95~0.98）**
4. **能有效结合陀螺仪和加速度计的优点**

### 5.2 使用建议

- 🎯 **快速原型开发**：首选互补滤波，快速验证方案
- 🎯 **资源受限项目**：单片机RAM<4KB时优先考虑
- 🎯 **实时控制系统**：控制周期<5ms时推荐使用
- 🎯 **精度要求不高**：±2°误差可接受的场合

### 5.3 进阶方向

如果互补滤波无法满足需求，考虑升级到：
- **扩展卡尔曼滤波（EKF）**：更高精度，能处理非线性
- **Madgwick滤波**：专为IMU设计，性能介于互补和卡尔曼之间
- **四元数互补滤波**：避免万向节死锁，适合全姿态估计

---

**参考资料：**
- Shane Colton, "The Balance Filter", MIT, 2007
- Mahony et al., "Nonlinear Complementary Filters on SO(3)", IEEE TAC, 2008
- 《无人机飞行控制系统设计》- 清华大学出版社
