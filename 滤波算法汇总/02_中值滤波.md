# 中值滤波算法详解

## 1. 算法原理

### 1.1 什么是中值滤波？

中值滤波是一种**非线性**滤波算法，它通过用采样窗口内所有数据的**中值**来替代当前采样值，从而达到滤波效果。

想象一下：你最近5次测量温度得到的数据是：`25, 24, 26, 100, 25`。显然，100这个数据是个异常值（可能是传感器瞬间出错）。如果我们把这5个数从小到大排序：`24, 25, 25, 26, 100`，取中间的值25作为当前温度，就能很好地消除这个异常值的影响。这就是中值滤波的核心思想。

### 1.2 数学原理

假设我们有一个数据序列：$x_1, x_2, x_3, ..., x_n$

中值滤波的输出 $y_i$ 定义为：

$$y_i = \text{median}(x_{i-k}, x_{i-k+1}, ..., x_i, ..., x_{i+k})$$

其中：
- $\text{median}$ 表示求中值
- $2k+1$ 是滤波窗口的长度（通常取奇数）
- 窗口内的数据需要先排序，然后取中间位置的值

**中值的定义：**
- 如果数据个数为奇数（如5个），中值就是排序后中间的那个数
- 如果数据个数为偶数（如4个），中值通常取中间两个数的平均值

### 1.3 工作机制

中值滤波的工作流程：

```
原始数据: [d1] [d2] [d3] [d4] [d5] [d6] [d7] ...
                  ↓
窗口大小 = 5，处理第3个数据：
1. 取出窗口内的数据: [d1, d2, d3, d4, d5]
2. 对这些数据排序: [排序后的序列]
3. 取中间位置的值作为输出
4. 窗口向右滑动一位，继续处理下一个数据
```

**关键特性：**
- **非线性处理**：不是简单的加权求和，而是通过排序找中值
- **保护边缘**：对边缘信息的保护好于平均值滤波
- **抗干扰强**：对脉冲干扰（突变噪声）有极强的抑制能力

## 2. C语言实现

详细的C语言实现请参见 `02_中值滤波.c` 文件。

核心代码结构：
```c
float median_filter(float new_value) {
    // 1. 更新数据缓存（移动窗口）
    // 2. 复制数据到临时数组
    // 3. 对临时数组进行排序
    // 4. 返回中值
}
```

## 3. 优缺点分析

### 3.1 优点

✅ **对脉冲干扰抑制能力强**
- 能有效滤除偶然出现的极大或极小值（如传感器瞬间故障）
- 对椒盐噪声（随机出现的突变点）效果特别好

✅ **保护边缘信息**
- 不会像均值滤波那样平滑掉信号的突变
- 适合需要保留信号变化特征的场合

✅ **不需要统计特性**
- 不需要假设噪声的分布类型
- 对各种类型的噪声都有较好的适应性

✅ **输出值必定是实际采样值之一**
- 输出值总是窗口内某个真实测量值
- 不会产生"不存在的值"

### 3.2 缺点

❌ **计算量较大**
- 每次都需要对窗口内数据排序
- 窗口越大，排序时间越长
- 不适合超高速采样场合

❌ **对高斯噪声效果不如均值滤波**
- 高斯噪声（正态分布的随机噪声）用均值滤波效果更好
- 中值滤波会损失一些平滑性

❌ **窗口过大会导致响应滞后**
- 窗口越大，对真实信号变化的响应越慢
- 需要在滤波效果和响应速度之间权衡

❌ **边界处理复杂**
- 刚开始采样时，窗口未填满，需要特殊处理
- 可能影响启动初期的数据质量

## 4. 适用场景

### 4.1 典型应用场景

**场景1：传感器数据采集**
```
应用：温度、压力、湿度等传感器数据处理
原因：传感器偶尔会因为电磁干扰产生脉冲噪声
示例：温度传感器测量 [25.1, 25.2, 88.0, 25.0, 25.1]
      第3个数据明显异常，中值滤波可以有效滤除
```

**场景2：ADC采样数据滤波**
```
应用：模数转换器采集的信号
原因：电源干扰、开关噪声会产生突变
示例：电压采样 [3.3, 3.3, 5.0, 3.3, 3.3]
      中间的5.0是干扰信号，需要滤除
```

**场景3：脉冲计数器抗干扰**
```
应用：转速测量、流量计数等
原因：机械振动或电磁干扰可能产生伪脉冲
效果：能有效滤除偶然出现的异常计数
```

**场景4：按键消抖**
```
应用：按键状态检测
原因：按键按下/释放瞬间会产生抖动
方法：对连续多次采样的按键状态取中值
```

### 4.2 不适用场景

❌ **需要极快响应的场合**
   - 例如：高速电机控制、快速保护电路
   - 原因：中值滤波有一定滞后性

❌ **信号变化缓慢且噪声为高斯分布**
   - 例如：电池电压监测
   - 原因：均值滤波更合适，计算量更小

❌ **资源极度受限的MCU**
   - 例如：8位单片机，RAM只有几百字节
   - 原因：排序算法占用资源较多

## 5. 参数调节建议

### 5.1 窗口长度的选择

**基本原则：**
- 窗口长度一般取**奇数**（3, 5, 7, 9, 11...）
- 常用值为 **5 或 7**

**选择依据：**

| 窗口长度 | 优点 | 缺点 | 适用场景 |
|---------|------|------|---------|
| 3 | 响应快，计算量小 | 滤波效果较弱 | 快速变化的信号，轻微噪声 |
| 5 | 平衡性好，最常用 | - | 一般传感器应用（推荐） |
| 7 | 滤波效果好 | 响应稍慢 | 噪声较大的场合 |
| 9~11 | 滤波效果很好 | 响应慢，计算量大 | 信号变化缓慢，噪声很大 |
| >11 | 滤波效果最好 | 响应很慢，不实用 | 一般不推荐 |

**实际测试方法：**
```
1. 从窗口长度5开始测试
2. 观察滤波后的数据是否还有明显突变
3. 如果突变仍然明显 → 增大窗口（改为7或9）
4. 如果信号响应太慢 → 减小窗口（改为3）
5. 在滤波效果和响应速度之间找到平衡点
```

### 5.2 采样频率的匹配

**原则：采样频率 = (3~5) × 信号最高频率**

例如：
- 温度变化最快每秒1度 → 采样频率可以是5Hz
- 电机转速最快每秒变化100转 → 采样频率应该在500Hz以上

**频率过高的问题：**
- 增加计算负担
- 可能采集到更多无用的高频噪声

**频率过低的问题：**
- 可能丢失信号的快速变化
- 滤波窗口覆盖的时间跨度太大

### 5.3 调试与优化建议

**第一步：验证基础功能**
```c
// 输入测试序列：[10, 10, 10, 10, 10]
// 期望输出：10
// 验证：算法是否正常工作

// 输入测试序列：[1, 2, 3, 4, 5]
// 期望输出：3（窗口长度5）
// 验证：中值计算是否正确
```

**第二步：测试抗干扰能力**
```c
// 输入测试序列：[50, 50, 50, 100, 50]
// 期望输出：50（窗口长度5）
// 验证：能否滤除单个脉冲干扰
```

**第三步：观察响应速度**
```c
// 输入从50突变到100的序列
// 观察输出需要多少个采样周期才能跟上
// 评估：响应速度是否满足要求
```

**第四步：实际环境测试**
```c
// 在真实系统中测试
// 观察波形是否平滑
// 检查是否有遗漏真实信号变化
```

### 5.4 常见问题与解决

**问题1：滤波后信号仍有毛刺**
```
原因：窗口太小，或连续出现多个异常值
解决：增大窗口长度（5→7→9）
```

**问题2：信号响应太慢**
```
原因：窗口太大
解决：减小窗口长度（9→7→5）
     或提高采样频率
```

**问题3：开机初期数据不稳定**
```
原因：滤波缓存未填满
解决：启动时预填充缓存为初始值
     或忽略前N个数据
```

**问题4：占用内存/CPU过高**
```
原因：窗口过大或采样频率过高
解决：优化排序算法（改用快速排序）
     减小窗口长度
     降低采样频率
```

## 6. 对比：中值滤波 vs 均值滤波

| 特性 | 中值滤波 | 均值滤波 |
|-----|---------|---------|
| 算法类型 | 非线性 | 线性 |
| 计算复杂度 | 高（需要排序） | 低（只需加法） |
| 脉冲干扰抑制 | ★★★★★ 优秀 | ★★☆☆☆ 较差 |
| 高斯噪声抑制 | ★★★☆☆ 一般 | ★★★★☆ 良好 |
| 边缘保护 | ★★★★☆ 良好 | ★★☆☆☆ 较差 |
| 响应速度 | ★★★☆☆ 一般 | ★★★★☆ 较快 |
| 适用场景 | 脉冲噪声、突变干扰 | 高斯噪声、平稳信号 |

**选择建议：**
- 如果主要是偶发的突变干扰 → **选中值滤波**
- 如果是持续的随机噪声 → **选均值滤波**
- 如果两种噪声都有 → 可以组合使用（先中值后均值）

## 7. 进阶优化

### 7.1 滑动窗口中值（适合连续采样）
不用每次都完全排序，只需要在排序好的数组中插入新值、删除旧值。

### 7.2 加权中值滤波
对窗口内的数据赋予不同权重，中心位置权重更高。

### 7.3 自适应窗口
根据噪声强度自动调整窗口大小。

## 8. 总结

中值滤波是嵌入式系统中处理脉冲干扰的**利器**，特别适合传感器数据采集场景。

**记住三个要点：**
1. **窗口长度选5最常用** - 在滤波效果和响应速度间取得平衡
2. **适合脉冲干扰** - 对偶发的突变噪声效果极好
3. **计算量比均值滤波大** - 需要排序操作，CPU占用稍高

**快速上手步骤：**
1. 复制示例代码到你的项目
2. 设置窗口长度为5
3. 在主循环中调用滤波函数
4. 观察效果，必要时调整窗口大小

---

**相关文档：**
- `01_限幅滤波.md` - 另一种处理突变的方法
- `03_算术平均滤波.md` - 线性滤波的代表

**参考资料：**
- 《数字信号处理》相关章节
- 嵌入式系统数据采集实践
